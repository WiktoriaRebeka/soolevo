{# ═══════════════════════════════════════════════════════════════════════════
   S2 — SCENARIUSZ GŁÓWNY (Standard)
   Zmienne: standard (ScenarioResponseItem dict), req
   Pola używane:
     total_power_kwp, panels_count, panel_brand, panel_model, panel_power_wp
     inverter_brand, inverter_model, inverter_power_kw
     annual_production_kwh, annual_consumption_kwh, coverage_percent
     pv_cost_gross_pln, pv_savings_pln, pv_payback_years,
     pv_payback_optimistic_years, pv_payback_pessimistic_years,
     pv_total_savings_25y_pln
     battery_recommended, is_economically_justified,
     total_cost_with_battery_pln, battery_payback_years,
     battery_payback_optimistic_years, battery_payback_pessimistic_years,
     battery_total_savings_25y_pln, battery_capacity_kwh, battery_model,
     autoconsumption_rate, self_sufficiency_rate,
     autoconsumption_rate_with_battery, self_sufficiency_rate_with_battery,
     net_billing_annual_deposit_pln, effective_surplus_rate, rationale,
     shading_loss_percent
   Makro: render_payback (z _macros.html)
   Filtry: format_pln, format_num
═══════════════════════════════════════════════════════════════════════════ #}

{% from 'report/_macros.html' import render_payback %}

{# ══════════════════════════════════════════════════════════════════
   CZĘŚĆ A — NAGŁÓWEK SCENARIUSZA + 3 VALUE BOXY + INWESTYCJA
══════════════════════════════════════════════════════════════════ #}

<div class="card tier-standard avoid-break" style="margin-bottom:16px; padding:20px 22px;">

    {# Sekcja-header z numerem #}
    <div class="section-header">
        <div class="section-header-num">S2</div>
        <div class="section-header-body" style="
            background: var(--light-blue);
            border-left-color: var(--c-accent);
        ">
            <div class="section-header-title">
                Scenariusz główny
                <span class="badge badge-standard" style="margin-left:8px; vertical-align:middle;">
                    STANDARD
                </span>
            </div>
            <div class="section-header-sub">
                {{ standard.description | default("Rekomendowany kompromis jakości i ceny") }}
            </div>
        </div>
    </div>

    {# ── Trzy value boxy ─────────────────────────────────────────── #}
    <div class="grid-3" style="margin-bottom:18px; gap:12px;">

        {# 1. Koszt instalacji #}
        <div class="stat-box bg-light-blue border-accent">
            <div class="label-sm">Koszt instalacji PV</div>
            <div class="value-xl text-accent">
                {{ standard.pv_cost_gross_pln | format_pln }}
            </div>
            <div class="text-sm text-muted" style="margin-top:4px;">
                ok. {{ standard.pv_payback_years | round(1) }} lat zwrotu
            </div>
        </div>

        {# 2. Zysk po 25 latach #}
        <div class="stat-box" style="background:#FFFBEB; border-color:#F59E0B;">
            <div class="label-sm">Szac. zysk po 25 latach</div>
            <div class="value-xl" style="color:#B45309;">
                ok. {{ standard.pv_total_savings_25y_pln | format_pln }}
            </div>
            <div class="text-sm text-muted" style="margin-top:4px;">
                ok. {{ standard.pv_savings_pln | format_pln }} / rok 1
            </div>
        </div>

        {# 3. Moc systemu #}
        <div class="stat-box bg-light-blue border-accent">
            <div class="label-sm">Moc systemu</div>
            <div class="value-xl text-accent">
                {{ "%.2f" | format(standard.total_power_kwp) }} kWp
            </div>
            <div class="text-sm text-muted" style="margin-top:4px;">
                {{ standard.panels_count }} paneli
                · {{ standard.annual_production_kwh | round | int | format_num }} kWh/rok
            </div>
        </div>

    </div>

    {# ── INWESTYCJA — dwie karty (PV / PV + Bateria) ─────────────── #}
    <div class="section-label">Inwestycja</div>

    {# Karta: Sama PV #}
    <div class="investment-card">
        <div>
            <div class="label-sm">Tylko panele PV</div>
            <div class="value-xl" style="color:var(--gray-900);">
                {{ standard.pv_cost_gross_pln | format_pln }}
            </div>
        </div>
        <div style="text-align:right; flex-shrink:0;">
            <div class="label-sm">Szacowany zwrot</div>
            <div class="value-base text-accent" style="white-space:nowrap;">
                {{ render_payback(
                    standard.pv_payback_years,
                    standard.pv_payback_optimistic_years,
                    standard.pv_payback_pessimistic_years
                ) }}
            </div>
        </div>
    </div>

    {# Karta: PV + Magazyn (jeśli dostępna) #}
    {% if standard.battery_recommended and standard.total_cost_with_battery_pln %}

    {% if standard.is_economically_justified %}
    <div class="investment-card--justified">
    {% else %}
    <div class="investment-card--neutral">
    {% endif %}

        <div>
            <div class="label-sm">
                {% if standard.is_economically_justified %}
                    PV + Magazyn energii
                    <span class="badge badge-premium" style="margin-left:6px;">ZALECANE</span>
                {% else %}
                    PV + Magazyn energii
                    <span class="badge" style="background:var(--gray-200); color:var(--gray-600); margin-left:6px;">OPCJONALNY</span>
                {% endif %}
            </div>
            <div class="value-xl" style="color:{{ 'var(--purple-700)' if standard.is_economically_justified else 'var(--gray-900)' }}; margin-top:4px;">
                {{ standard.total_cost_with_battery_pln | format_pln }}
            </div>
            {% if standard.battery_model %}
            <div class="text-sm text-muted" style="margin-top:3px;">
                Magazyn: {{ standard.battery_model }}
                ({{ standard.battery_capacity_kwh | round(1) }} kWh)
            </div>
            {% endif %}
        </div>
        <div style="text-align:right; flex-shrink:0;">
            <div class="label-sm">Zwrot z magazynem</div>
            <div class="value-base" style="
                color:{{ 'var(--purple-700)' if standard.is_economically_justified else 'var(--gray-500)' }};
                white-space:nowrap;
            ">
                {{ render_payback(
                    standard.battery_payback_years,
                    standard.battery_payback_optimistic_years,
                    standard.battery_payback_pessimistic_years
                ) }}
            </div>
        </div>

    </div>

    {# Rekomendacja ekspercka dot. baterii #}
    {% if standard.rationale %}
    <div class="alert {{ 'alert-blue' if standard.is_economically_justified else '' }}"
         style="margin-top:10px;">
        <p class="text-sm" style="margin:0; line-height:1.6; color:var(--gray-700);">
            {{ standard.rationale }}
        </p>
    </div>
    {% endif %}

    {% endif %}{# /battery_recommended #}

</div>{# /card S2-A #}

{# ══════════════════════════════════════════════════════════════════
   STRONA-BREAK — S2-B na nowej stronie
══════════════════════════════════════════════════════════════════ #}
<div class="page-break"></div>

{# ══════════════════════════════════════════════════════════════════
   CZĘŚĆ B — EFEKTYWNOŚĆ + PRZEPŁYW ENERGII
══════════════════════════════════════════════════════════════════ #}

<div style="display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:16px;">

    {# ── LEWA: Progress bary efektywności ──────────────────────── #}
    <div class="card avoid-break" style="padding:18px 20px;">
        <div class="section-label">Efektywność systemu</div>

        {# Autokonsumpcja (bez baterii) #}
        {% set ac_pct = ((standard.autoconsumption_rate | default(0)) * 100) | round | int %}
        <div class="progress-container">
            <div class="progress-header">
                <span class="progress-title">Autokonsumpcja PV</span>
                <span class="progress-value text-accent">{{ ac_pct }}%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill progress-fill--standard"
                     style="width:{{ [ac_pct,100] | min }}%;"></div>
            </div>
            <div class="progress-sublabel">Ile produkcji zużywasz na bieżąco</div>
        </div>

        {# Samowystarczalność (bez baterii) #}
        {% set ss_pct = ((standard.self_sufficiency_rate | default(0)) * 100) | round | int %}
        <div class="progress-container">
            <div class="progress-header">
                <span class="progress-title">Samowystarczalność</span>
                <span class="progress-value text-accent">{{ ss_pct }}%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill progress-fill--standard"
                     style="width:{{ [ss_pct,100] | min }}%;"></div>
            </div>
            <div class="progress-sublabel">Ile zapotrzebowania pokrywa PV</div>
        </div>

        {# Pokrycie zapotrzebowania #}
        {% set cov_pct = (standard.coverage_percent | default(0)) | round | int %}
        {% if cov_pct > 0 %}
        <div class="progress-container">
            <div class="progress-header">
                <span class="progress-title">Pokrycie zużycia</span>
                <span class="progress-value text-accent">{{ cov_pct }}%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill progress-fill--standard"
                     style="width:{{ [cov_pct,100] | min }}%;"></div>
            </div>
            <div class="progress-sublabel">Produkcja vs. roczne zużycie</div>
        </div>
        {% endif %}

        {# Autokonsumpcja z baterią (jeśli dostępna) #}
        {% if standard.battery_recommended and standard.autoconsumption_rate_with_battery %}
        {% set acb_pct = ((standard.autoconsumption_rate_with_battery | default(0)) * 100) | round | int %}
        <div class="progress-container">
            <div class="progress-header">
                <span class="progress-title">Autokonsumpcja z magazynem</span>
                <span class="progress-value text-purple">{{ acb_pct }}%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill progress-fill--premium"
                     style="width:{{ [acb_pct,100] | min }}%;"></div>
            </div>
            <div class="progress-sublabel">To samo, ale z baterią</div>
        </div>
        {% endif %}

        {# Samowystarczalność z baterią #}
        {% if standard.battery_recommended and standard.self_sufficiency_rate_with_battery %}
        {% set ssb_pct = ((standard.self_sufficiency_rate_with_battery | default(0)) * 100) | round | int %}
        <div class="progress-container">
            <div class="progress-header">
                <span class="progress-title">Samowystarczalność z magazynem</span>
                <span class="progress-value text-purple">{{ ssb_pct }}%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill progress-fill--premium"
                     style="width:{{ [ssb_pct,100] | min }}%;"></div>
            </div>
            <div class="progress-sublabel">Niezależność energetyczna z baterią</div>
        </div>
        {% endif %}

    </div>

    {# ── PRAWA: Bilans energetyczny ─────────────────────────────── #}
    <div class="card avoid-break" style="padding:18px 20px;">
        <div class="section-label">Bilans energetyczny</div>

        <div class="box-gray" style="margin-bottom:12px;">
            <div class="param-row">
                <span class="text-muted">Roczna produkcja PV</span>
                <span class="value-bold text-accent">
                    {{ standard.annual_production_kwh | round | int | format_num }} kWh
                </span>
            </div>
            <div class="param-row">
                <span class="text-muted">Roczne zużycie</span>
                <span class="value-bold">
                    {{ standard.annual_consumption_kwh | round | int | format_num }} kWh
                </span>
            </div>
            {% if standard.surplus_kwh is not none %}
            <div class="param-row">
                <span class="text-muted">Nadwyżka do sieci</span>
                <span class="value-bold">
                    {{ standard.surplus_kwh | round | int | format_num }} kWh
                </span>
            </div>
            {% endif %}
            <div class="param-row">
                <span class="text-muted">Net-billing — depozyt roczny</span>
                <span class="value-bold">
                    {{ standard.net_billing_annual_deposit_pln | format_pln }}
                </span>
            </div>
            <div class="param-row">
                <span class="text-muted">Stawka net-billing (RCEm)</span>
                <span class="value-bold">
                    {% if standard.effective_surplus_rate %}
                        {{ "%.3f" | format(standard.effective_surplus_rate) }} zł/kWh
                    {% else %}—{% endif %}
                </span>
            </div>
            {% if standard.shading_loss_percent and standard.shading_loss_percent > 0 %}
            <div class="param-row">
                <span class="text-muted">Straty przez zacienienie</span>
                <span class="value-bold" style="color:var(--c-yellow);">
                    {{ standard.shading_loss_percent | round(1) }}%
                </span>
            </div>
            {% endif %}
        </div>

        {# Nota o net-billingu #}
        <div style="
            background: var(--gray-50);
            border:     1px solid var(--gray-200);
            border-left:3px solid var(--c-accent);
            border-radius: var(--r-md);
            padding:    10px 12px;
        ">
            <div class="label-sm" style="margin-bottom:4px;">Net-billing — jak to działa?</div>
            <p class="text-xs text-muted" style="margin:0; line-height:1.55;">
                Nadwyżki energii trafiają do sieci i są zapisywane jako depozyt pieniężny
                (ok. 30% ceny detalicznej). Możesz go rozliczać przez 12 miesięcy.
                Im wyższa autokonsumpcja, tym lepsza ekonomika.
            </p>
        </div>

    </div>

</div>

{# ══════════════════════════════════════════════════════════════════
   CZĘŚĆ C — PARAMETRY SYSTEMU + PRZEDZIAŁY ZWROTU
══════════════════════════════════════════════════════════════════ #}

<div class="card avoid-break" style="margin-bottom:16px; padding:18px 22px;">

    <div class="section-label">Parametry systemu — Scenariusz Standard</div>

    <div class="grid-2" style="gap:0 28px;">

        {# Lewa: sprzęt #}
        <div>
            <div class="param-row">
                <span class="text-muted">Moc systemu</span>
                <span class="value-bold text-accent">
                    {{ "%.2f" | format(standard.total_power_kwp) }} kWp
                </span>
            </div>
            <div class="param-row">
                <span class="text-muted">Liczba paneli</span>
                <span class="value-bold">{{ standard.panels_count }} szt.</span>
            </div>
            <div class="param-row">
                <span class="text-muted">Model paneli</span>
                <span class="value-bold">
                    {{ standard.panel_brand | default("—") }}
                    {% if standard.panel_power_wp %}
                        · {{ standard.panel_power_wp }} Wp
                    {% endif %}
                </span>
            </div>
            <div class="param-row">
                <span class="text-muted">Falownik</span>
                <span class="value-bold">
                    {{ standard.inverter_brand | default("—") }}
                    {% if standard.inverter_power_kw %}
                        · {{ standard.inverter_power_kw | round(1) }} kW
                    {% endif %}
                </span>
            </div>
        </div>

        {# Prawa: scenariusze zwrotu #}
        <div>
            <div class="section-label" style="font-size:var(--fs-xs);">Przedziały czasu zwrotu</div>

            {# Tabela: optymistyczny / bazowy / pesymistyczny #}
            <table class="data-table avoid-break" style="font-size:var(--fs-sm);">
                <thead>
                    <tr>
                        <th style="text-align:left;">Scenariusz</th>
                        <th style="text-align:center;">Tylko PV</th>
                        {% if standard.battery_recommended %}<th style="text-align:center;">PV + Bateria</th>{% endif %}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="color:var(--c-green); font-weight:700;">Optymistyczny (inflacja 6%)</td>
                        <td style="text-align:center; font-weight:700;">
                            {{ standard.pv_payback_optimistic_years | round(1) }} lat
                        </td>
                        {% if standard.battery_recommended and standard.battery_payback_optimistic_years %}
                        <td style="text-align:center; font-weight:700; color:var(--purple-700);">
                            {{ standard.battery_payback_optimistic_years | round(1) }} lat
                        </td>
                        {% elif standard.battery_recommended %}
                        <td style="text-align:center;">—</td>
                        {% endif %}
                    </tr>
                    <tr>
                        <td style="font-weight:700; color:var(--c-accent);">Bazowy (inflacja 4%)</td>
                        <td style="text-align:center; font-weight:800; color:var(--c-accent);">
                            {{ standard.pv_payback_years | round(1) }} lat
                        </td>
                        {% if standard.battery_recommended and standard.battery_payback_years %}
                        <td style="text-align:center; font-weight:800; color:var(--purple-700);">
                            {{ standard.battery_payback_years | round(1) }} lat
                        </td>
                        {% elif standard.battery_recommended %}
                        <td style="text-align:center;">—</td>
                        {% endif %}
                    </tr>
                    <tr>
                        <td style="color:var(--c-yellow); font-weight:700;">Pesymistyczny (inflacja 2%)</td>
                        <td style="text-align:center; font-weight:700;">
                            {{ standard.pv_payback_pessimistic_years | round(1) }} lat
                        </td>
                        {% if standard.battery_recommended and standard.battery_payback_pessimistic_years %}
                        <td style="text-align:center; font-weight:700; color:var(--purple-700);">
                            {{ standard.battery_payback_pessimistic_years | round(1) }} lat
                        </td>
                        {% elif standard.battery_recommended %}
                        <td style="text-align:center;">—</td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>

            <p class="text-xs text-muted" style="margin-top:8px; line-height:1.5;">
                Scenariusze zakładają roczny wzrost cen energii odpowiednio 6%, 4% i 2%.
                Rzeczywisty zwrot zależy od lokalnych warunków i cen prądu.
            </p>
        </div>

    </div>

</div>