{# ═══════════════════════════════════════════════════════════════════════════
   S3 — WYKRESY ENERGETYCZNE
   ─────────────────────────────────────────────────────────────────────────
   Wykres 1 (miesięczny bilans) — bez page-break, naturalnie dołącza do S2C
   Wykres 2 (cashflow 25 lat)   — po page-break, nowa strona
   Wykres 3 (dobowy lato+zima)  — na tej samej stronie co Wykres 2

   WAŻNE:
   • Legenda Wykresu 1 jest wbudowana w obrazek PNG (matplotlib fig.legend)
     → NIE duplikujemy jej w HTML
   • Legenda Wykresu 3 jest wbudowana w obrazek PNG (jedna wspólna na dole)
     → NIE duplikujemy jej w HTML
   • Stary blok z kolorami #27AE60, #F39C12, #E74C3C, #2980B9 USUNIĘTY
═══════════════════════════════════════════════════════════════════════════ #}

{# ─── WYKRES 1: Miesięczny bilans energii ────────────────────────────────── #}
{# Celowo BEZ page-break — naturalnie dołącza do parametrów systemu z S2C    #}

<div class="card avoid-break" style="margin-top: 16px; margin-bottom: 0; padding: 16px 20px;">

    <div style="font-size: 11px; font-weight: 700; text-transform: uppercase;
                letter-spacing: .05em; color: var(--c-primary); margin-bottom: 10px;">
        Miesięczny bilans energii — Scenariusz Standard
    </div>

    {% if charts and charts.monthly_balance %}

        {# Wykres PNG — legenda wbudowana przez matplotlib fig.legend() #}
        <img src="data:image/png;base64,{{ charts.monthly_balance }}"
             alt="Miesięczny bilans energii"
             style="width: 100%; border-radius: 8px; display: block;">

    {% else %}

        {# ── FALLBACK: tabela HTML gdy matplotlib niedostępny ─────────────── #}
        {% set ap = standard.annual_production_kwh or 0 %}
        {% set ac = standard.annual_consumption_kwh or (data.annual_consumption_kwh or 0) %}
        {% set seasons = [
            ('Styczeń–Luty',         0.07, 0.19),
            ('Marzec–Kwiecień',      0.18, 0.17),
            ('Maj–Czerwiec',         0.25, 0.15),
            ('Lipiec–Sierpień',      0.25, 0.14),
            ('Wrzesień–Październik', 0.16, 0.17),
            ('Listopad–Grudzień',    0.09, 0.18)
        ] %}
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
                <tr style="background:var(--gray-100); border-bottom:2px solid var(--gray-200);">
                    <th style="text-align:left; padding:7px 10px; font-weight:700; color:var(--gray-700);">Okres</th>
                    <th style="text-align:right; padding:7px 10px; font-weight:700; color:var(--c-accent);">Produkcja kWh</th>
                    <th style="text-align:right; padding:7px 10px; font-weight:700; color:var(--gray-700);">Zużycie kWh</th>
                    <th style="padding:7px 10px; font-weight:700; color:var(--gray-700); width:40%;">Bilans</th>
                </tr>
            </thead>
            <tbody>
                {% for label, pw, cw in seasons %}
                {% set pv = (ap * pw) | round | int %}
                {% set cv = (ac * cw) | round | int %}
                {% set av = [pv, cv] | min %}
                {% set sv = pv - av %}
                {% set gv = cv - av %}
                {% set bm = [pv, cv] | max %}
                {% set ap_pct = ((av / bm) * 100) | round | int if bm > 0 else 0 %}
                {% set sp_pct = ((sv / bm) * 100) | round | int if bm > 0 else 0 %}
                {% set gp_pct = ((gv / bm) * 100) | round | int if bm > 0 else 0 %}
                <tr style="border-bottom:1px solid var(--gray-100);
                           {% if loop.index is even %}background:var(--gray-50);{% endif %}">
                    <td style="padding:6px 10px; font-weight:600; color:var(--gray-700);">{{ label }}</td>
                    <td style="padding:6px 10px; text-align:right; font-weight:700; color:var(--c-accent);">{{ pv }}</td>
                    <td style="padding:6px 10px; text-align:right; color:var(--gray-600);">{{ cv }}</td>
                    <td style="padding:6px 10px;">
                        <div style="display:flex; height:10px; border-radius:4px;
                                    overflow:hidden; background:var(--gray-200);">
                            {% if ap_pct > 0 %}<div style="width:{{ ap_pct }}%; background:#22c55e;"></div>{% endif %}
                            {% if sp_pct > 0 %}<div style="width:{{ sp_pct }}%; background:#facc15;"></div>{% endif %}
                            {% if gp_pct > 0 %}<div style="width:{{ gp_pct }}%; background:#ef4444; margin-left:auto;"></div>{% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {# Legenda fallbacku — kolory ZSYNCHRONIZOWANE z report_generator.py v5.0 #}
        <div style="display:flex; gap:16px; margin-top:10px; flex-wrap:wrap;">
            <div style="display:flex; align-items:center; gap:5px;">
                <div style="width:12px; height:12px; background:#22c55e; border-radius:2px;"></div>
                <span style="font-size:11px; color:var(--gray-600);">Autokonsumpcja</span>
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <div style="width:12px; height:12px; background:#facc15; border-radius:2px;"></div>
                <span style="font-size:11px; color:var(--gray-600);">Nadwyżka do sieci</span>
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <div style="width:12px; height:12px; background:#ef4444; border-radius:2px;"></div>
                <span style="font-size:11px; color:var(--gray-600);">Pobór z sieci</span>
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <div style="width:14px; height:3px; background:#3b82f6; border-radius:2px; margin-top:5px;"></div>
                <span style="font-size:11px; color:var(--gray-600);">Zapotrzebowanie</span>
            </div>
        </div>

    {% endif %}

</div>


{# ─── PAGE BREAK przed Wykresem 2 ────────────────────────────────────────── #}
<div class="page-break"></div>


{# ─── WYKRES 2: Prognoza zysku netto (25 lat) — CashflowChart25 ─────────── #}

<div class="card avoid-break" style="margin-bottom: 16px; padding: 16px 20px;">

    <div style="font-size: 11px; font-weight: 700; text-transform: uppercase;
                letter-spacing: .05em; color: var(--c-primary); margin-bottom: 10px;">
        Prognoza zysku netto — 25 lat (inflacja energii +4% rocznie)
    </div>

    {% if charts and charts.payback %}

        <img src="data:image/png;base64,{{ charts.payback }}"
             alt="Prognoza zysku netto 25 lat"
             style="width: 100%; border-radius: 8px; display: block;">

    {% else %}

        {# ── FALLBACK: tabela kluczowych wartości finansowych ─────────────── #}
        <div class="box-gray">
            <div class="param-row">
                <span class="text-muted">Inwestycja startowa</span>
                <span class="value-bold" style="color:#C0392B;">
                    –{{ standard.pv_cost_gross_pln | format_pln }}
                </span>
            </div>
            <div class="param-row">
                <span class="text-muted">Roczne oszczędności (rok 1)</span>
                <span class="value-bold text-accent">
                    ok. {{ standard.pv_savings_pln | format_pln }}
                </span>
            </div>
            <div class="param-row">
                <span class="text-muted">Prognozowany zwrot (zakres 3–6% inflacji)</span>
                <span class="value-bold text-accent">
                    ok.
                    {{ standard.pv_payback_optimistic_years | round(1)
                       if standard.pv_payback_optimistic_years else '?' }}
                    –
                    {{ standard.pv_payback_pessimistic_years | round(1)
                       if standard.pv_payback_pessimistic_years else '?' }}
                    lat
                </span>
            </div>
            <div class="param-row">
                <span class="text-muted">Szacowany zysk netto po 25 latach</span>
                <span class="value-bold" style="color:#1E8449;">
                    ok. {{ standard.pv_total_savings_25y_pln | format_pln }}
                </span>
            </div>
            {% if standard.battery_recommended and standard.with_battery_total_cost_pln %}
            <div class="param-row">
                <span class="text-muted">Zysk z wariantem PV + magazyn / 25 lat</span>
                <span class="value-bold" style="color:#7c3aed;">
                    ok. {{ standard.total_savings_25y_with_battery_pln | format_pln }}
                </span>
            </div>
            {% endif %}
        </div>

    {% endif %}

</div>


{# ─── WYKRES 3: Dobowy przepływ energii (lato + zima) ───────────────────── #}

<div class="card avoid-break" style="padding: 16px 20px;">

    <div style="font-size: 11px; font-weight: 700; text-transform: uppercase;
                letter-spacing: .05em; color: var(--c-primary); margin-bottom: 10px;">
        Dobowy przepływ energii — przykładowy dzień (lato vs. zima)
    </div>

    {% if charts and charts.daily_flow %}

        {# Wykres PNG — legenda wbudowana przez matplotlib fig.legend() na dole #}
        <img src="data:image/png;base64,{{ charts.daily_flow }}"
             alt="Dobowy przepływ energii"
             style="width: 100%; border-radius: 8px; display: block;">

    {% else %}

        {# ── FALLBACK: informacja tekstowa gdy brak danych godzinowych ──────── #}
        <div style="background:var(--gray-50); border:1px dashed var(--gray-300);
                    border-radius:10px; padding:20px; text-align:center;">
            <p class="text-sm text-muted" style="margin:0; line-height:1.6;">
                Wykres dobowy niedostępny — brak danych godzinowych w tej symulacji.<br>
                Produkcja roczna:
                <strong class="text-accent">
                    {{ standard.annual_production_kwh | round | int }} kWh
                </strong>
                &nbsp;·&nbsp; Autokonsumpcja:
                <strong>
                    {{ ((standard.autoconsumption_rate or 0) * 100) | round | int }}%
                </strong>
            </p>
        </div>

        {# Legenda fallbacku — kolory zsynchronizowane z report_generator.py v5.0 #}
        <div style="display:flex; gap:14px; margin-top:12px; flex-wrap:wrap;
                    justify-content:center;">
            <div style="display:flex; align-items:center; gap:5px;">
                <div style="width:12px;height:12px;background:#D4AC0D;border-radius:2px;"></div>
                <span style="font-size:11px;color:var(--gray-600);">Produkcja PV</span>
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <div style="width:12px;height:12px;background:#E57373;border-radius:2px;"></div>
                <span style="font-size:11px;color:var(--gray-600);">Pobór z sieci</span>
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <div style="width:12px;height:12px;background:#2E86C1;border-radius:2px;"></div>
                <span style="font-size:11px;color:var(--gray-600);">Zużycie domu</span>
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <div style="width:12px;height:12px;background:#66BB6A;border-radius:2px;"></div>
                <span style="font-size:11px;color:var(--gray-600);">Ładowanie bat.</span>
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <div style="width:12px;height:12px;background:#A78BFA;border-radius:2px;"></div>
                <span style="font-size:11px;color:var(--gray-600);">Rozładowanie bat.</span>
            </div>
        </div>

    {% endif %}

</div>