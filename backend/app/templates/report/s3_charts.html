{# ═══════════════════════════════════════════════════════════════════════════
   S3 — WYKRESY ENERGETYCZNE  v2.0
   Zmiany vs v1.0:
   - Legenda dobowego wykresu: flex-wrap → display:grid (fix RYZYKO-przesuniecia)
   - Pasek tytułowy każdego wykresu: ujednolicony z resztą dokumentu
   - Komentarze do "Jak czytać" — skrócone, bardziej zwięzłe
   Klucze charts{}: monthly_balance, payback, daily_flow, roof_panels
═══════════════════════════════════════════════════════════════════════════ #}

{# ══════════════════════════════════════════════════════════
   NAGŁÓWEK S3
══════════════════════════════════════════════════════════ #}
<div class="section-header avoid-break" style="margin-bottom:18px;">
    <div class="section-header-num">S3</div>
    <div class="section-header-body">
        <div class="section-header-title">Wizualizacje energetyczne</div>
        <div class="section-header-sub">
            Scenariusz Standard · symulacja godzinowa · inflacja energii +4%/rok
        </div>
    </div>
</div>

{# ══════════════════════════════════════════════════════════
   KARTA ZBIORCZA 1: Miesięczny bilans + Cashflow 25 lat
══════════════════════════════════════════════════════════ #}
<div class="card avoid-break" style="margin-bottom:0; padding:20px 22px; page-break-inside:avoid;">

    {# ── WYKRES 1: Miesięczny bilans energii ── #}
    <div style="margin-bottom:20px;">

        {# Pasek tytułowy — ujednolicony z resztą sekcji #}
        <div style="
            display:       flex;
            align-items:   center;
            gap:           10px;
            margin-bottom: 14px;
            padding-bottom:10px;
            border-bottom: 1px solid var(--gray-200);
        ">
            <div style="width:4px; height:22px; background:var(--c-accent); border-radius:2px; flex-shrink:0;"></div>
            <div>
                <div style="font-size:var(--fs-h3); font-weight:800; color:var(--gray-900);">
                    Miesięczny bilans energii
                </div>
                <div class="text-xs text-muted">Scenariusz Standard · cały rok kalendarzowy</div>
            </div>
            {# Mini-legenda inline — 4 kafelki w jednej linii #}
            <div style="
                margin-left:    auto;
                display:        grid;
                grid-template-columns: repeat(4, auto);
                gap:            0 16px;
                flex-shrink:    0;
            ">
                {% for color, label in [
                    ('#0D7377', 'Autokonsumpcja'),
                    ('#C9963C', 'Nadwyżka do sieci'),
                    ('#A04050', 'Pobór z sieci'),
                    ('#1B4F72', 'Zapotrzebowanie'),
                ] %}
                <div style="display:flex; align-items:center; gap:5px;">
                    <div style="
                        width:10px; height:10px;
                        background:{{ color }};
                        border-radius:2px;
                        flex-shrink:0;
                    "></div>
                    <span style="font-size:6.5pt; color:var(--gray-600); white-space:nowrap;">{{ label }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        {% if charts and charts.monthly_balance %}
            <img src="data:image/png;base64,{{ charts.monthly_balance }}"
                 alt="Miesięczny bilans energii"
                 style="width:100%; max-height:260px; object-fit:contain; display:block; margin:0 auto;">
        {% else %}
            {# FALLBACK: tabela sezonowa #}
            {% set ap = standard.annual_production_kwh | default(0) %}
            {% set ac = standard.annual_consumption_kwh | default(data.annual_consumption_kwh | default(0)) %}
            {% set seasons = [
                ('Sty – Lut',  0.07, 0.19),
                ('Mar – Kwi',  0.18, 0.17),
                ('Maj – Cze',  0.25, 0.15),
                ('Lip – Sie',  0.25, 0.14),
                ('Wrz – Paź',  0.16, 0.17),
                ('Lis – Gru',  0.09, 0.18),
            ] %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Okres</th>
                        <th style="text-align:right; color:#C9963C;">Produkcja kWh</th>
                        <th style="text-align:right;">Zużycie kWh</th>
                        <th style="text-align:right; color:#0D7377;">Autokonsumpcja kWh</th>
                    </tr>
                </thead>
                <tbody>
                    {% for label, pw, cw in seasons %}
                    {% set pv = (ap * pw) | round | int %}
                    {% set cv = (ac * cw) | round | int %}
                    <tr>
                        <td>{{ label }}</td>
                        <td style="text-align:right; font-weight:700; color:#C9963C;">{{ pv | format_num }}</td>
                        <td style="text-align:right;">{{ cv | format_num }}</td>
                        <td style="text-align:right; color:#0D7377; font-weight:700;">
                            {{ ([pv, cv] | min) | format_num }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}

        <div style="margin-top:10px; padding:8px 12px; background:var(--gray-50); border-left:3px solid var(--c-accent); border-radius:0 var(--r-sm) var(--r-sm) 0;">
            <p class="text-xs text-muted" style="margin:0; line-height:1.6;">
                Latem produkcja PV znacznie przekracza bieżące zużycie — nadwyżka trafia do sieci lub ładuje magazyn. Zimą konieczne jest częściowe uzupełnienie z sieci.
            </p>
        </div>
    </div>

    {# Separator #}
    <hr style="border:0; border-top:1px dashed var(--gray-200); margin: 18px 0;">

    {# ── WYKRES 2: Cashflow 25 lat ── #}
    <div>
        <div style="
            display:       flex;
            align-items:   center;
            gap:           10px;
            margin-bottom: 14px;
            padding-bottom:10px;
            border-bottom: 1px solid var(--gray-200);
        ">
            <div style="width:4px; height:22px; background:#C9963C; border-radius:2px; flex-shrink:0;"></div>
            <div>
                <div style="font-size:var(--fs-h3); font-weight:800; color:var(--gray-900);">
                    Prognoza skumulowanego zysku — 25 lat
                </div>
                <div class="text-xs text-muted">Inflacja energii +4% rocznie · scenariusz bazowy</div>
            </div>
            <div style="margin-left:auto; text-align:center; flex-shrink:0;">
                <div class="label-sm">Zwrot inwestycji</div>
                <div style="font-size:var(--fs-h3); font-weight:900; color:#C9963C;">
                    ~{{ standard.pv_payback_years | default(0) | round(1) }} lat
                </div>
            </div>
        </div>

        {% if charts and charts.payback %}
            <img src="data:image/png;base64,{{ charts.payback }}"
                 alt="Prognoza zysku netto 25 lat"
                 style="width:100%; max-height:260px; object-fit:contain; display:block; margin:0 auto;">
        {% else %}
            <div class="box-gray">
                <div class="param-row">
                    <span class="text-muted">Inwestycja startowa</span>
                    <span class="value-bold" style="color:#A04050;">−{{ standard.pv_cost_gross_pln | default(0) | format_pln }}</span>
                </div>
                <div class="param-row">
                    <span class="text-muted">Zysk po 25 latach</span>
                    <span class="value-bold" style="color:#C9963C;">ok. {{ standard.pv_total_savings_25y_pln | default(0) | format_pln }}</span>
                </div>
            </div>
        {% endif %}

        <div style="margin-top:10px; padding:8px 12px; background:var(--gray-50); border-left:3px solid #C9963C; border-radius:0 var(--r-sm) var(--r-sm) 0;">
            <p class="text-xs text-muted" style="margin:0; line-height:1.6;">
                Złota krzywa PV rośnie po przekroczeniu progu zerowego — to moment zwrotu inwestycji. Od tej chwili instalacja generuje czysty zysk.
            </p>
        </div>
    </div>
</div>

{# ══════════════════════════════════════════════════════════
   STRONA B: ANALIZA TECHNICZNA
══════════════════════════════════════════════════════════ #}
<div class="page-break"></div>

<div class="section-header avoid-break" style="margin-bottom:14px;">
    <div class="section-header-num">S4</div>
    <div class="section-header-body">
        <div class="section-header-title">Analiza techniczna i operacyjna</div>
        <div class="section-header-sub">Profile zużycia · Rozmieszczenie modułów</div>
    </div>
</div>

<div class="card avoid-break" style="margin-bottom:0; padding:20px 22px; page-break-inside:avoid;">

    {# ── WYKRES 3: Dobowy profil energii ── #}
    <div style="margin-bottom:20px;">

        {# Pasek tytułowy #}
        <div style="
            display:       flex;
            align-items:   center;
            gap:           10px;
            margin-bottom: 14px;
            padding-bottom:10px;
            border-bottom: 1px solid var(--gray-200);
        ">
            <div style="width:4px; height:22px; background:var(--c-accent); border-radius:2px; flex-shrink:0;"></div>
            <div>
                <div style="font-size:var(--fs-h3); font-weight:800; color:var(--gray-900);">
                    Dobowy profil przepływu energii
                </div>
                <div class="text-xs text-muted">Typowy dzień letni i zimowy · godz. 0:00–23:00</div>
            </div>
        </div>

        {% if charts and charts.daily_flow %}
            <img src="data:image/png;base64,{{ charts.daily_flow }}"
                 alt="Dobowy profil energetyczny"
                 style="width:100%; max-height:260px; object-fit:contain; display:block; margin:0 auto;">
        {% else %}
            <div style="padding:20px; text-align:center; color:var(--gray-400);">Wykres niedostępny</div>
        {% endif %}

        {# ── LEGENDA — grid zamiast flex-wrap (fix: brzydkie przesunięcie) ── #}
        <div style="
            margin-top:    12px;
            padding:       10px 14px;
            background:    var(--gray-50);
            border-radius: var(--r-md);
        ">
            {# Dwa wiersze × 3 kolumny — zawsze wyrównane #}
            <div style="
                display:               grid;
                grid-template-columns: repeat(3, 1fr);
                gap:                   6px 0;
                margin-bottom:         8px;
            ">
                {% for color, label in [
                    ('#C9963C', 'Produkcja PV'),
                    ('#A04050', 'Pobór z sieci'),
                    ('#1B4F72', 'Zużycie domu'),
                    ('#0D7377', 'Ładowanie baterii'),
                    ('#7C5DC7', 'Rozładowanie baterii'),
                    ('#374151', 'Stan naładowania (SOC)'),
                ] %}
                <div style="display:flex; align-items:center; gap:6px;">
                    <div style="
                        width:12px; height:12px;
                        background:{{ color }};
                        border-radius:2px;
                        flex-shrink:0;
                    "></div>
                    <span style="font-size:7pt; color:var(--gray-600);">{{ label }}</span>
                </div>
                {% endfor %}
            </div>
            <p class="text-xs text-muted" style="margin:0; line-height:1.6; border-top:1px solid var(--gray-200); padding-top:6px;">
                Szczyt produkcji PV: godz. 10:00–15:00. Nadwyżka ładuje baterię lub trafia do sieci. Rano i wieczorem dom korzysta z baterii lub importu.
            </p>
        </div>
    </div>

    {# Separator #}
    <hr style="border:0; border-top:1px dashed var(--gray-200); margin: 18px 0;">

    {# ── WYKRES 4: Schemat dachu ── #}
    {% if charts and charts.roof_panels %}
    <div>
        <div style="
            display:       flex;
            align-items:   center;
            gap:           10px;
            margin-bottom: 14px;
            padding-bottom:10px;
            border-bottom: 1px solid var(--gray-200);
        ">
            <div style="width:4px; height:22px; background:var(--c-primary); border-radius:2px; flex-shrink:0;"></div>
            <div>
                <div style="font-size:var(--fs-h3); font-weight:800; color:var(--gray-900);">
                    Schemat rozmieszczenia paneli
                </div>
                <div class="text-xs text-muted">
                    {{ standard.panels_count | default("—") }} paneli · {{ "%.2f" | format(standard.total_power_kwp | default(0)) }} kWp
                </div>
            </div>
        </div>

        <div style="text-align:center; background:var(--gray-50); border-radius:var(--r-md); padding:10px;">
            <img src="data:image/png;base64,{{ charts.roof_panels }}"
                 alt="Schemat rozmieszczenia paneli na dachu"
                 style="max-width:100%; max-height:260px; display:inline-block; border-radius:var(--r-sm);">
        </div>

        <div style="margin-top:10px; padding:8px 12px; background:var(--gray-50); border-left:3px solid var(--c-primary); border-radius:0 var(--r-sm) var(--r-sm) 0;">
            <p class="text-xs text-muted" style="margin:0; line-height:1.6;">
                Wizualizacja poglądowa — rzeczywisty schemat montażowy wykonuje projektant instalacji podczas audytu technicznego.
            </p>
        </div>
    </div>
    {% endif %}

</div>