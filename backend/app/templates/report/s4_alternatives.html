{# ═══════════════════════════════════════════════════════════════════════════
   S4 — PORÓWNANIE WARIANTÓW
   Zmienne: standard, economy, premium (ScenarioResponseItem dicts, top-level)
   Makro:   render_payback (z _macros.html)
   Filtry:  format_pln, format_num
   UWAGA:   standard/economy/premium mogą być pustymi dictami {} — wszystkie
            odwołania owinięte w guard: {% if standard %} / | default(0)
═══════════════════════════════════════════════════════════════════════════ #}

{% from 'report/_macros.html' import render_payback %}

{# ── Kolory per-tier (zsynchronizowane z TIER_COLORS w ScenarioCard.jsx) ── #}
{% set T = {
    "standard": {
        "badge_cls":  "badge-standard",
        "color":      "var(--c-primary)",
        "accent":     "var(--c-accent)",
        "bg":         "var(--light-blue)",
        "border":     "var(--mid-blue)",
        "bar_cls":    "progress-fill--standard",
        "left_border":"4px solid var(--c-accent)",
        "label":      "Standard",
        "desc":       "Rekomendowany kompromis jakości i ceny"
    },
    "economy": {
        "badge_cls":  "badge-economy",
        "color":      "var(--c-green)",
        "accent":     "var(--c-green)",
        "bg":         "var(--light-green)",
        "border":     "var(--mid-green)",
        "bar_cls":    "progress-fill--economy",
        "left_border":"4px solid var(--c-green)",
        "label":      "Economy",
        "desc":       "Najtańsza opcja — komponenty budżetowe"
    },
    "premium": {
        "badge_cls":  "badge-premium",
        "color":      "var(--purple-700)",
        "accent":     "var(--purple-700)",
        "bg":         "var(--purple-50)",
        "border":     "var(--purple-200)",
        "bar_cls":    "progress-fill--premium",
        "left_border":"4px solid var(--purple-500)",
        "label":      "Premium",
        "desc":       "Najwyższa jakość — panele premium, pełna gwarancja"
    }
} %}

{# ══════════════════════════════════════════════════════════
   NAGŁÓWEK S4
══════════════════════════════════════════════════════════ #}
<div class="section-header avoid-break" style="margin-bottom:18px;">
    <div class="section-header-num">S4</div>
    <div class="section-header-body">
        <div class="section-header-title">Porównanie wariantów</div>
        <div class="section-header-sub">
            Economy · Standard (rekomendowany) · Premium
        </div>
    </div>
</div>

{# ══════════════════════════════════════════════════════════
   TRZY PIONOWE KARTY (flex row, równe szerokości)
══════════════════════════════════════════════════════════ #}
<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; margin-bottom:20px;">

    {# ── Makro karty wariantu ── #}
    {# Jinja2 nie ma makr z blokami, więc używamy pętli #}
    {% for tier_name, sc in [("economy", economy), ("standard", standard), ("premium", premium)] %}
    {% set t = T[tier_name] %}

    <div style="
        background:    {% if tier_name == 'standard' %}var(--light-blue){% else %}white{% endif %};
        border:        2px solid {{ t.border }};
        border-left:   {{ t.left_border }};
        border-radius: var(--r-lg);
        overflow:      hidden;
        break-inside:  avoid;
        page-break-inside: avoid;
        position:      relative;
    ">
        {# Pasek tytułowy #}
        <div style="
            background:  {{ t.color }};
            padding:     12px 16px;
            display:     flex;
            align-items: center;
            gap:         10px;
        ">
            <span class="badge {{ t.badge_cls }}">{{ t.label }}</span>
            {% if tier_name == 'standard' %}
            <span style="
                background: white;
                color:      var(--c-primary);
                font-size:  var(--fs-badge);
                font-weight:900;
                padding:    2px 8px;
                border-radius: var(--r-pill);
                text-transform: uppercase;
                letter-spacing: .06em;
            ">REKOMENDOWANY</span>
            {% endif %}
        </div>

        <div style="padding:14px 16px;">

            {# Opis #}
            <p class="text-xs text-muted" style="margin-bottom:12px; line-height:1.5;">
                {% if sc %}{{ sc.description | default(t.desc) }}{% else %}{{ t.desc }}{% endif %}
            </p>

            {% if sc %}

            {# ── Główna kwota — koszt #}
            <div style="text-align:center; margin-bottom:14px; padding-bottom:12px;
                        border-bottom:1px solid var(--gray-200);">
                <div class="label-sm" style="margin-bottom:4px;">Koszt instalacji PV</div>
                <div style="
                    font-size:   var(--fs-h1);
                    font-weight: 900;
                    color:       {{ t.accent }};
                    line-height: 1.1;
                ">
                    {{ sc.pv_cost_gross_pln | default(0) | format_pln }}
                </div>
                {% if sc.battery_recommended and sc.total_cost_with_battery_pln %}
                <div class="text-xs text-muted" style="margin-top:3px;">
                    z magazynem: {{ sc.total_cost_with_battery_pln | format_pln }}
                </div>
                {% endif %}
            </div>

            {# ── Parametry techniczne #}
            <div class="param-row">
                <span class="text-muted">Moc systemu</span>
                <span class="value-bold" style="color:{{ t.accent }};">
                    {{ "%.2f" | format(sc.total_power_kwp | default(0)) }} kWp
                </span>
            </div>
            <div class="param-row">
                <span class="text-muted">Liczba paneli</span>
                <span class="value-bold">{{ sc.panels_count | default(0) }} szt.</span>
            </div>
            <div class="param-row">
                <span class="text-muted">Roczna produkcja</span>
                <span class="value-bold">
                    {{ sc.annual_production_kwh | default(0) | round | int | format_num }} kWh
                </span>
            </div>
            <div class="param-row">
                <span class="text-muted">Panel</span>
                <span class="value-bold" style="font-size:var(--fs-xs);">
                    {{ sc.panel_brand | default("—") }}
                    {% if sc.panel_power_wp %}&nbsp;{{ sc.panel_power_wp }} Wp{% endif %}
                </span>
            </div>
            <div class="param-row">
                <span class="text-muted">Falownik</span>
                <span class="value-bold" style="font-size:var(--fs-xs);">
                    {{ sc.inverter_brand | default("—") }}
                </span>
            </div>

            {# ── Finansowe #}
            <div style="margin-top:12px; padding-top:10px; border-top:1px solid var(--gray-200);">

                <div class="param-row">
                    <span class="text-muted">Zwrot inwestycji</span>
                    <span class="value-bold" style="color:{{ t.accent }};">
                        {{ render_payback(
                            sc.pv_payback_years,
                            sc.pv_payback_optimistic_years,
                            sc.pv_payback_pessimistic_years
                        ) }}
                    </span>
                </div>
                <div class="param-row">
                    <span class="text-muted">Oszczędności rok&nbsp;1</span>
                    <span class="value-bold">
                        ok. {{ sc.pv_savings_pln | default(0) | format_pln }}
                    </span>
                </div>
                <div class="param-row">
                    <span class="text-muted">Zysk po 25 latach</span>
                    <span class="value-bold" style="color:{{ t.accent }};">
                        ok. {{ sc.pv_total_savings_25y_pln | default(0) | format_pln }}
                    </span>
                </div>

            </div>

            {# ── Efektywność — progress bar #}
            {% set ss_pct = ((sc.self_sufficiency_rate | default(0)) * 100) | round | int %}
            <div style="margin-top:12px; padding-top:10px; border-top:1px solid var(--gray-200);">
                <div class="progress-header">
                    <span class="progress-title">Samowystarczalność</span>
                    <span class="progress-value" style="color:{{ t.accent }};">{{ ss_pct }}%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill {{ t.bar_cls }}"
                         style="width:{{ [ss_pct, 100] | min }}%;"></div>
                </div>
            </div>

            {% else %}
            {# Wariant niedostępny #}
            <div style="text-align:center; padding:20px; color:var(--gray-400); font-size:var(--fs-sm);">
                Wariant niedostępny dla podanego dachu
            </div>
            {% endif %}

        </div>{# /padding #}
    </div>{# /card #}
    {% endfor %}

</div>{# /grid-3 #}

{# ══════════════════════════════════════════════════════════
   TABELA ZBIORCZA — szybkie porównanie w 1 rzucie oka
══════════════════════════════════════════════════════════ #}
<div class="card avoid-break" style="padding:16px 20px;">

    <div class="section-label" style="margin-bottom:12px;">Tabela porównawcza</div>

    <table class="data-table">
        <thead>
            <tr>
                <th style="width:32%; text-align:left;">Parametr</th>
                <th style="text-align:center; background:#1A7A40;">
                    Economy
                </th>
                <th style="text-align:center; background:var(--c-primary);">
                    Standard ★
                </th>
                <th style="text-align:center; background:var(--purple-700);">
                    Premium
                </th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Moc systemu [kWp]</td>
                <td style="text-align:center; color:#1A7A40; font-weight:700;">
                    {% if economy %}{{ "%.2f" | format(economy.total_power_kwp | default(0)) }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center; color:var(--c-accent); font-weight:800;"
                    class="comp-table-std">
                    {% if standard %}{{ "%.2f" | format(standard.total_power_kwp | default(0)) }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center; color:var(--purple-700); font-weight:700;">
                    {% if premium %}{{ "%.2f" | format(premium.total_power_kwp | default(0)) }}{% else %}—{% endif %}
                </td>
            </tr>
            <tr>
                <td>Liczba paneli [szt.]</td>
                <td style="text-align:center;">
                    {% if economy %}{{ economy.panels_count | default("—") }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center; font-weight:700;" class="comp-table-std">
                    {% if standard %}{{ standard.panels_count | default("—") }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center;">
                    {% if premium %}{{ premium.panels_count | default("—") }}{% else %}—{% endif %}
                </td>
            </tr>
            <tr>
                <td>Roczna produkcja [kWh]</td>
                <td style="text-align:center;">
                    {% if economy %}{{ economy.annual_production_kwh | default(0) | round | int | format_num }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center; font-weight:700;" class="comp-table-std">
                    {% if standard %}{{ standard.annual_production_kwh | default(0) | round | int | format_num }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center;">
                    {% if premium %}{{ premium.annual_production_kwh | default(0) | round | int | format_num }}{% else %}—{% endif %}
                </td>
            </tr>
            <tr>
                <td>Koszt instalacji PV</td>
                <td style="text-align:center; color:#1A7A40; font-weight:700;">
                    {% if economy %}{{ economy.pv_cost_gross_pln | default(0) | format_pln }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center; color:var(--c-accent); font-weight:800;"
                    class="comp-table-std">
                    {% if standard %}{{ standard.pv_cost_gross_pln | default(0) | format_pln }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center; color:var(--purple-700); font-weight:700;">
                    {% if premium %}{{ premium.pv_cost_gross_pln | default(0) | format_pln }}{% else %}—{% endif %}
                </td>
            </tr>
            <tr>
                <td>Zwrot inwestycji [lata]</td>
                <td style="text-align:center; font-weight:700;">
                    {% if economy %}{{ economy.pv_payback_years | default(0) | round(1) }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center; font-weight:800; color:var(--c-accent);"
                    class="comp-table-std">
                    {% if standard %}{{ standard.pv_payback_years | default(0) | round(1) }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center; font-weight:700;">
                    {% if premium %}{{ premium.pv_payback_years | default(0) | round(1) }}{% else %}—{% endif %}
                </td>
            </tr>
            <tr>
                <td>Zysk po 25 latach</td>
                <td style="text-align:center; color:#1A7A40; font-weight:700;">
                    {% if economy %}ok. {{ economy.pv_total_savings_25y_pln | default(0) | format_pln }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center; color:var(--c-accent); font-weight:800;"
                    class="comp-table-std">
                    {% if standard %}ok. {{ standard.pv_total_savings_25y_pln | default(0) | format_pln }}{% else %}—{% endif %}
                </td>
                <td style="text-align:center; color:var(--purple-700); font-weight:700;">
                    {% if premium %}ok. {{ premium.pv_total_savings_25y_pln | default(0) | format_pln }}{% else %}—{% endif %}
                </td>
            </tr>
            <tr>
                <td>Samowystarczalność</td>
                <td style="text-align:center;">
                    {% if economy %}{{ ((economy.self_sufficiency_rate | default(0)) * 100) | round | int }}%{% else %}—{% endif %}
                </td>
                <td style="text-align:center; font-weight:700;" class="comp-table-std">
                    {% if standard %}{{ ((standard.self_sufficiency_rate | default(0)) * 100) | round | int }}%{% else %}—{% endif %}
                </td>
                <td style="text-align:center;">
                    {% if premium %}{{ ((premium.self_sufficiency_rate | default(0)) * 100) | round | int }}%{% else %}—{% endif %}
                </td>
            </tr>
            <tr>
                <td>Gwarancja na produkcję</td>
                <td style="text-align:center;">25 lat (80%)</td>
                <td style="text-align:center; font-weight:700;" class="comp-table-std">25 lat (80%)</td>
                <td style="text-align:center;">30 lat (80%)</td>
            </tr>
        </tbody>
    </table>

    <p class="text-xs text-muted" style="margin-top:8px; line-height:1.5;">
        ★ Scenariusz Standard jest domyślnie rekomendowany jako optymalny kompromis
        jakości, ceny i czasu zwrotu. Wszystkie kwoty są brutto (z VAT 23%).
    </p>

</div>